package com.malware.authservice.usecase;

import com.malware.authservice.domain.model.User;
import com.malware.authservice.exception.MalformedCommandException;
import com.malware.authservice.exception.UserAlreadyExistsException;
import com.malware.authservice.factory.IEncryptionAlgorithm;
import com.malware.authservice.port.in.RegisterUserCommand;
import com.malware.authservice.repo.IUserRepository;

import java.security.NoSuchAlgorithmException;
import java.util.UUID;

public class RegisterUserUseCase extends UserValidations {

    private final IEncryptionAlgorithm encryptionAlgorithm;

    public RegisterUserUseCase(IUserRepository userRepository, IEncryptionAlgorithm encryptionAlgorithm) {
        super(userRepository);
        this.encryptionAlgorithm = encryptionAlgorithm;
    }

    public String encryptPassword(String password) throws NoSuchAlgorithmException {
        return encryptionAlgorithm.encrypt(password);
    }

    public void validateCommand(RegisterUserCommand command) throws MalformedCommandException {
        if (!command.validate()) throw new MalformedCommandException();
    }

    public User registerUser(RegisterUserCommand command) throws
            UserAlreadyExistsException,
            MalformedCommandException,
            NoSuchAlgorithmException
    {
        validateCommand(command);
        if (checkUserExists(command.getEmail())) throw new UserAlreadyExistsException();

        User user = User.from(command);
        user.setPassword(encryptPassword(user.getPassword()));
        user.setUID(UUID.randomUUID().toString());

        return userRepository.save(user);
    }
}
